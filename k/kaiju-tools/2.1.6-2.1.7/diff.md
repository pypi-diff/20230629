# Comparing `tmp/kaiju_tools-2.1.6-py3-none-any.whl.zip` & `tmp/kaiju_tools-2.1.7-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,55 +1,55 @@
-Zip file size: 98519 bytes, number of entries: 53
--rw-r--r--  2.0 unx      231 b- defN 23-Jun-27 21:35 kaiju_tools/__init__.py
--rw-r--r--  2.0 unx    15027 b- defN 23-Jun-27 21:35 kaiju_tools/annotations.py
--rw-r--r--  2.0 unx    37347 b- defN 23-Jun-27 21:35 kaiju_tools/app.py
--rw-r--r--  2.0 unx     4699 b- defN 23-Jun-27 21:35 kaiju_tools/cache.py
--rw-r--r--  2.0 unx     5430 b- defN 23-Jun-27 21:35 kaiju_tools/class_registry.py
--rw-r--r--  2.0 unx    12475 b- defN 23-Jun-27 21:35 kaiju_tools/encoding.py
--rw-r--r--  2.0 unx     5310 b- defN 23-Jun-27 21:35 kaiju_tools/exceptions.py
--rw-r--r--  2.0 unx     8706 b- defN 23-Jun-27 21:35 kaiju_tools/functions.py
--rw-r--r--  2.0 unx    11388 b- defN 23-Jun-27 21:35 kaiju_tools/http.py
--rw-r--r--  2.0 unx    10864 b- defN 23-Jun-27 21:35 kaiju_tools/interfaces.py
--rw-r--r--  2.0 unx    10179 b- defN 23-Jun-27 21:35 kaiju_tools/jsonschema.py
--rw-r--r--  2.0 unx     7548 b- defN 23-Jun-27 21:35 kaiju_tools/locks.py
--rw-r--r--  2.0 unx    10446 b- defN 23-Jun-27 21:35 kaiju_tools/logging.py
--rw-r--r--  2.0 unx      210 b- defN 23-Jun-27 21:35 kaiju_tools/loop.py
--rw-r--r--  2.0 unx     7839 b- defN 23-Jun-27 21:35 kaiju_tools/mapping.py
--rw-r--r--  2.0 unx    35361 b- defN 23-Jun-27 21:35 kaiju_tools/rpc.py
--rw-r--r--  2.0 unx     4416 b- defN 23-Jun-27 21:35 kaiju_tools/rpc_client_gen.py
--rw-r--r--  2.0 unx       95 b- defN 23-Jun-27 21:35 kaiju_tools/serialization.py
--rw-r--r--  2.0 unx      702 b- defN 23-Jun-27 21:35 kaiju_tools/services.py
--rw-r--r--  2.0 unx    16671 b- defN 23-Jun-27 21:35 kaiju_tools/sessions.py
--rw-r--r--  2.0 unx     9328 b- defN 23-Jun-27 21:35 kaiju_tools/streams.py
--rw-r--r--  2.0 unx    14417 b- defN 23-Jun-27 21:35 kaiju_tools/templates.py
--rw-r--r--  2.0 unx    12410 b- defN 23-Jun-27 21:35 kaiju_tools/types.py
--rw-r--r--  2.0 unx      103 b- defN 23-Jun-27 21:35 kaiju_tools/docker/__init__.py
--rw-r--r--  2.0 unx     9790 b- defN 23-Jun-27 21:35 kaiju_tools/docker/containers.py
--rw-r--r--  2.0 unx     7723 b- defN 23-Jun-27 21:35 kaiju_tools/docker/images.py
--rw-r--r--  2.0 unx    11216 b- defN 23-Jun-27 21:35 kaiju_tools/docker/stack.py
--rw-r--r--  2.0 unx        0 b- defN 23-Jun-27 21:35 kaiju_tools/docker/tests/__init__.py
--rw-r--r--  2.0 unx     1306 b- defN 23-Jun-27 21:35 kaiju_tools/docker/tests/fixtures.py
--rw-r--r--  2.0 unx      575 b- defN 23-Jun-27 21:35 kaiju_tools/docker/tests/test_containers.py
--rw-r--r--  2.0 unx      359 b- defN 23-Jun-27 21:35 kaiju_tools/docker/tests/test_images.py
--rw-r--r--  2.0 unx      371 b- defN 23-Jun-27 21:35 kaiju_tools/docker/tests/test_stack.py
--rw-r--r--  2.0 unx        0 b- defN 23-Jun-27 21:35 kaiju_tools/tests/__init__.py
--rw-r--r--  2.0 unx    19588 b- defN 23-Jun-27 21:35 kaiju_tools/tests/fixtures.py
--rw-r--r--  2.0 unx     9209 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_annotation_parser.py
--rw-r--r--  2.0 unx     1469 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_cache.py
--rw-r--r--  2.0 unx     1436 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_class_registry.py
--rw-r--r--  2.0 unx      552 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_configurator.py
--rw-r--r--  2.0 unx     3091 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_data_store.py
--rw-r--r--  2.0 unx     2848 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_http.py
--rw-r--r--  2.0 unx     2097 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_locks.py
--rw-r--r--  2.0 unx     3457 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_mapping.py
--rw-r--r--  2.0 unx     9192 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_rpc.py
--rw-r--r--  2.0 unx     1554 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_scheduler.py
--rw-r--r--  2.0 unx     2800 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_serializers.py
--rw-r--r--  2.0 unx     2207 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_services.py
--rw-r--r--  2.0 unx     3267 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_streams.py
--rw-r--r--  2.0 unx     1692 b- defN 23-Jun-27 21:35 kaiju_tools/tests/test_templates.py
--rw-rw-rw-  2.0 unx      610 b- defN 23-Jun-27 21:35 kaiju_tools-2.1.6.dist-info/LICENSE
--rw-r--r--  2.0 unx     3360 b- defN 23-Jun-27 21:35 kaiju_tools-2.1.6.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Jun-27 21:35 kaiju_tools-2.1.6.dist-info/WHEEL
--rw-r--r--  2.0 unx       12 b- defN 23-Jun-27 21:35 kaiju_tools-2.1.6.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     4517 b- defN 23-Jun-27 21:35 kaiju_tools-2.1.6.dist-info/RECORD
-53 files, 345592 bytes uncompressed, 91353 bytes compressed:  73.6%
+Zip file size: 98967 bytes, number of entries: 53
+-rw-r--r--  2.0 unx      231 b- defN 23-Jun-29 08:53 kaiju_tools/__init__.py
+-rw-r--r--  2.0 unx    15027 b- defN 23-Jun-29 08:53 kaiju_tools/annotations.py
+-rw-r--r--  2.0 unx    37347 b- defN 23-Jun-29 08:53 kaiju_tools/app.py
+-rw-r--r--  2.0 unx     4699 b- defN 23-Jun-29 08:53 kaiju_tools/cache.py
+-rw-r--r--  2.0 unx     5430 b- defN 23-Jun-29 08:53 kaiju_tools/class_registry.py
+-rw-r--r--  2.0 unx    12475 b- defN 23-Jun-29 08:53 kaiju_tools/encoding.py
+-rw-r--r--  2.0 unx     5310 b- defN 23-Jun-29 08:53 kaiju_tools/exceptions.py
+-rw-r--r--  2.0 unx     8706 b- defN 23-Jun-29 08:53 kaiju_tools/functions.py
+-rw-r--r--  2.0 unx    11388 b- defN 23-Jun-29 08:53 kaiju_tools/http.py
+-rw-r--r--  2.0 unx    11123 b- defN 23-Jun-29 08:53 kaiju_tools/interfaces.py
+-rw-r--r--  2.0 unx    10179 b- defN 23-Jun-29 08:53 kaiju_tools/jsonschema.py
+-rw-r--r--  2.0 unx     7548 b- defN 23-Jun-29 08:53 kaiju_tools/locks.py
+-rw-r--r--  2.0 unx    10446 b- defN 23-Jun-29 08:53 kaiju_tools/logging.py
+-rw-r--r--  2.0 unx      210 b- defN 23-Jun-29 08:53 kaiju_tools/loop.py
+-rw-r--r--  2.0 unx     7839 b- defN 23-Jun-29 08:53 kaiju_tools/mapping.py
+-rw-r--r--  2.0 unx    35361 b- defN 23-Jun-29 08:53 kaiju_tools/rpc.py
+-rw-r--r--  2.0 unx     4416 b- defN 23-Jun-29 08:53 kaiju_tools/rpc_client_gen.py
+-rw-r--r--  2.0 unx       95 b- defN 23-Jun-29 08:53 kaiju_tools/serialization.py
+-rw-r--r--  2.0 unx      702 b- defN 23-Jun-29 08:53 kaiju_tools/services.py
+-rw-r--r--  2.0 unx    17768 b- defN 23-Jun-29 08:53 kaiju_tools/sessions.py
+-rw-r--r--  2.0 unx     9379 b- defN 23-Jun-29 08:53 kaiju_tools/streams.py
+-rw-r--r--  2.0 unx    14417 b- defN 23-Jun-29 08:53 kaiju_tools/templates.py
+-rw-r--r--  2.0 unx    12410 b- defN 23-Jun-29 08:53 kaiju_tools/types.py
+-rw-r--r--  2.0 unx      103 b- defN 23-Jun-29 08:53 kaiju_tools/docker/__init__.py
+-rw-r--r--  2.0 unx     9786 b- defN 23-Jun-29 08:53 kaiju_tools/docker/containers.py
+-rw-r--r--  2.0 unx     7727 b- defN 23-Jun-29 08:53 kaiju_tools/docker/images.py
+-rw-r--r--  2.0 unx    11216 b- defN 23-Jun-29 08:53 kaiju_tools/docker/stack.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Jun-29 08:53 kaiju_tools/docker/tests/__init__.py
+-rw-r--r--  2.0 unx     1306 b- defN 23-Jun-29 08:53 kaiju_tools/docker/tests/fixtures.py
+-rw-r--r--  2.0 unx      575 b- defN 23-Jun-29 08:53 kaiju_tools/docker/tests/test_containers.py
+-rw-r--r--  2.0 unx      359 b- defN 23-Jun-29 08:53 kaiju_tools/docker/tests/test_images.py
+-rw-r--r--  2.0 unx      371 b- defN 23-Jun-29 08:53 kaiju_tools/docker/tests/test_stack.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Jun-29 08:53 kaiju_tools/tests/__init__.py
+-rw-r--r--  2.0 unx    20499 b- defN 23-Jun-29 08:53 kaiju_tools/tests/fixtures.py
+-rw-r--r--  2.0 unx     9209 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_annotation_parser.py
+-rw-r--r--  2.0 unx     1469 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_cache.py
+-rw-r--r--  2.0 unx     1436 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_class_registry.py
+-rw-r--r--  2.0 unx      552 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_configurator.py
+-rw-r--r--  2.0 unx     3091 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_data_store.py
+-rw-r--r--  2.0 unx     2848 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_http.py
+-rw-r--r--  2.0 unx     2097 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_locks.py
+-rw-r--r--  2.0 unx     3457 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_mapping.py
+-rw-r--r--  2.0 unx     9192 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_rpc.py
+-rw-r--r--  2.0 unx     1554 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_scheduler.py
+-rw-r--r--  2.0 unx     2800 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_serializers.py
+-rw-r--r--  2.0 unx     2207 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_services.py
+-rw-r--r--  2.0 unx     3288 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_streams.py
+-rw-r--r--  2.0 unx     1692 b- defN 23-Jun-29 08:53 kaiju_tools/tests/test_templates.py
+-rw-rw-rw-  2.0 unx      610 b- defN 23-Jun-29 08:53 kaiju_tools-2.1.7.dist-info/LICENSE
+-rw-r--r--  2.0 unx     3360 b- defN 23-Jun-29 08:53 kaiju_tools-2.1.7.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jun-29 08:53 kaiju_tools-2.1.7.dist-info/WHEEL
+-rw-r--r--  2.0 unx       12 b- defN 23-Jun-29 08:53 kaiju_tools-2.1.7.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     4517 b- defN 23-Jun-29 08:53 kaiju_tools-2.1.7.dist-info/RECORD
+53 files, 347931 bytes uncompressed, 91801 bytes compressed:  73.6%
```

## zipnote {}

```diff
@@ -138,23 +138,23 @@
 
 Filename: kaiju_tools/tests/test_streams.py
 Comment: 
 
 Filename: kaiju_tools/tests/test_templates.py
 Comment: 
 
-Filename: kaiju_tools-2.1.6.dist-info/LICENSE
+Filename: kaiju_tools-2.1.7.dist-info/LICENSE
 Comment: 
 
-Filename: kaiju_tools-2.1.6.dist-info/METADATA
+Filename: kaiju_tools-2.1.7.dist-info/METADATA
 Comment: 
 
-Filename: kaiju_tools-2.1.6.dist-info/WHEEL
+Filename: kaiju_tools-2.1.7.dist-info/WHEEL
 Comment: 
 
-Filename: kaiju_tools-2.1.6.dist-info/top_level.txt
+Filename: kaiju_tools-2.1.7.dist-info/top_level.txt
 Comment: 
 
-Filename: kaiju_tools-2.1.6.dist-info/RECORD
+Filename: kaiju_tools-2.1.7.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## kaiju_tools/__init__.py

```diff
@@ -1,8 +1,8 @@
 from kaiju_tools.interfaces import *
 from kaiju_tools.types import *
 from kaiju_tools.app import *
 from kaiju_tools.encoding import Serializable
 
-__version__ = '2.1.6'
+__version__ = '2.1.7'
 __python_version__ = '3.8'
 __author__ = 'antonnidhoggr@me.com'
```

## kaiju_tools/interfaces.py

```diff
@@ -154,84 +154,83 @@
 
     @abc.abstractmethod
     async def m_exists(self, id: Collection[NSKey]) -> FrozenSet[NSKey]:
         ...
 
 
 _Columns = Union[Collection[str], Literal['*'], None]
-_Row = TypeVar('_Row')
 
 
-class DataStore(Generic[_Row], abc.ABC):
+class DataStore(abc.ABC):
     """Data row-column store."""
 
     @abc.abstractmethod
-    async def get(self, id: Hashable, columns: _Columns = '*', _connection=None) -> _Row:
+    async def get(self, id: Hashable, columns: _Columns = '*', _connection=None):
         ...
 
     @abc.abstractmethod
-    async def m_get(self, id: Collection[Hashable], columns: _Columns = '*', _connection=None) -> Collection[_Row]:
+    async def m_get(self, id: Collection[Hashable], columns: _Columns = '*', _connection=None):
         ...
 
     @abc.abstractmethod
-    async def exists(self, id: Hashable, _connection=None) -> bool:
+    async def exists(self, id: Hashable, _connection=None):
         ...
 
     @abc.abstractmethod
-    async def m_exists(self, id: Collection[Hashable], _connection=None) -> FrozenSet[Hashable]:
+    async def m_exists(self, id: Collection[Hashable], _connection=None):
         ...
 
     @abc.abstractmethod
-    async def delete(self, id: Hashable, columns: _Columns = None, _connection=None) -> _Row:
+    async def delete(self, id: Hashable, columns: _Columns = None, _connection=None):
         ...
 
     @abc.abstractmethod
     async def m_delete(
         self, id: Collection[Hashable] = None, conditions: dict = None, columns: _Columns = None, _connection=None
-    ) -> Collection[_Row]:
+    ):
         ...
 
     @abc.abstractmethod
     async def create(
         self,
         data: dict,
         columns: _Columns = '*',
         _connection=None,
         on_conflict: str = None,
         on_conflict_keys: Collection = None,
         on_conflict_values=None,
-    ) -> _Row:
+    ):
         ...
 
     @abc.abstractmethod
     async def m_create(
         self,
         data: Collection,
         columns: _Columns = '*',
         _connection=None,
         on_conflict: str = None,
         on_conflict_keys: Collection = None,
         on_conflict_values: dict = None,
-    ) -> Collection[_Row]:
+    ):
         ...
 
     @abc.abstractmethod
-    async def update(self, id: Hashable, data, columns: _Columns = '*', _connection=None) -> _Row:
+    async def update(self, id: Hashable, data, columns: _Columns = '*', _connection=None):
         ...
 
     @abc.abstractmethod
     async def m_update(
         self, id: Collection[Hashable], data, conditions: dict = None, columns: _Columns = '*', _connection=None
-    ) -> Collection[_Row]:
+    ):
         ...
 
     @abc.abstractmethod
     async def iter(
         self, conditions: dict = None, sort=None, offset: int = 0, limit: int = 10, columns: _Columns = '*'
-    ) -> AsyncGenerator[List[dict], None]:
+    ) -> AsyncGenerator[List, None]:
         ...
 
 
 _User = TypeVar('_User')
 
 
 class UserInterface(Generic[_User], abc.ABC):
@@ -240,14 +239,26 @@
     @abc.abstractmethod
     async def auth(self, username: str, password: str) -> Optional[_User]:
         """User login and password check.
 
         Must return None if no user or token is invalid.
         """
 
+    @abc.abstractmethod
+    async def register(self, username: str, email: str, password: str, settings: dict = None) -> _User:
+        """Register a new user."""
+
+    @abc.abstractmethod
+    async def change_password(self, username: str, password: str, new_password: str):
+        """Change user password."""
+
+    @abc.abstractmethod
+    async def update_profile(self, id: uuid.UUID, settings: dict):
+        """Update current user profile."""
+
 
 class TokenInterface(Generic[_User], abc.ABC):
     """Auth token interface."""
 
     class TokenClaims(TypedDict):
         """JWT token claims data."""
```

## kaiju_tools/sessions.py

```diff
@@ -303,43 +303,62 @@
 
     def __init__(
         self,
         *args,
         session_service: SessionInterface = None,
         auth_service: AuthenticationInterface = None,
         token_service: TokenInterface = None,
+        user_service: UserInterface = None,
         **kws,
     ):
         super().__init__(*args, **kws)
         self._sessions = session_service
         self._auth = auth_service
+        self._users = user_service
         self._tokens = token_service
 
     @property
     def routes(self) -> dict:
         return {
             'login': self.login,
             'jwt.get': self.get_token,
             'jwt.refresh': self.refresh_token,
             'logout': self.logout,
+            'register': self.register,
+            'change_password': self.change_password,
+            'update_profile': self.update_profile,
         }
 
     @property
     def permissions(self) -> dict:
         return {
             'login': self.PermissionKeys.GLOBAL_GUEST_PERMISSION,
+            'register': self.PermissionKeys.GLOBAL_GUEST_PERMISSION,
+            'change_password': self.PermissionKeys.GLOBAL_GUEST_PERMISSION,
             'logout': self.PermissionKeys.GLOBAL_USER_PERMISSION,
             'jwt.get': self.PermissionKeys.GLOBAL_GUEST_PERMISSION,
-            'jwt.refresh': self.PermissionKeys.GLOBAL_GUEST_PERMISSION,
+            'update_profile': self.PermissionKeys.GLOBAL_USER_PERMISSION,
         }
 
     async def init(self):
         self._sessions = self.discover_service(self._sessions, cls=SessionInterface)
         self._auth = self.discover_service(self._auth, cls=AuthenticationInterface)
         self._tokens = self.discover_service(self._tokens, cls=TokenInterface, required=False)
+        self._users = self.discover_service(self._users, cls=UserInterface)
+
+    async def register(self, username: str, email: str, password: str) -> _Session:
+        await self._users.register(username=username, email=email, password=password)
+        return await self.login(username=username, password=password)
+
+    async def change_password(self, username: str, password: str, new_password: str) -> _Session:
+        await self._users.change_password(username=username, password=password, new_password=new_password)
+        return await self.login(username=username, password=new_password)
+
+    async def update_profile(self, settings: dict):
+        return await self._users.update_profile(self.get_user_id(), settings)
 
     async def login(self, username: str, password: str) -> _Session:
         """Authenticate a user by directly providing a login / password."""
         session = self.get_session()
         if session and session.user_id:
             await self.logout()
             session = self.get_session()
```

## kaiju_tools/streams.py

```diff
@@ -28,22 +28,22 @@
 
     content_type = MimeTypes.msgpack
     lock_check_interval = 1
 
     def __init__(
         self,
         app,
-        topic: str,
+        topic: str = Topic.RPC,
         rpc_service: JSONRPCServer = None,
         locks_service: Locks = None,
         scheduler: Scheduler = None,
         session_service: SessionInterface = None,
         authentication_service: AuthenticationInterface = None,
         transport: Service = None,
-        shared: bool = True,
+        shared: bool = False,
         max_parallel_batches: int = None,
         logger: Adapter = None,
     ):
         super().__init__(app=app, logger=logger)
         self._transport = transport
         self.topic = topic
         self.max_parallel_batches = max_parallel_batches
@@ -155,23 +155,23 @@
 
 
 class StreamRPCClient(BaseRPCClient, abc.ABC):
     """Stream client for RPC requests."""
 
     transport_cls: Type
 
-    def __init__(self, *args, app_name: str, topic: str = Topic.RPC, **kws):
+    def __init__(self, *args, app_name: str = None, topic: str = Topic.RPC, **kws):
         """Initialize.
 
         :param app_name: application (topic) name
         :param listener_service: stream listener service instance
         :param topic: topic name
         """
         super().__init__(*args, **kws)
-        self.app_name = app_name
+        self.app_name = app_name if app_name else self.app.name
         self.topic = topic
         self._ns = Namespace(env=self.app.env, name='__stream__').create_namespace('_stream').get_key(topic)
 
     async def init(self):
         self._transport = self.discover_service(self._transport, cls=self.get_transport_cls())
         await super().init()
```

## kaiju_tools/docker/containers.py

```diff
@@ -1,15 +1,15 @@
 """Docker container management."""
 
 import uuid
 from time import sleep
 from typing import Awaitable, Union
 
-import docker  # noqa: tests only
-from docker.errors import NotFound  # noqa: tests only
+import docker  # noqa: optional
+from docker.errors import NotFound  # noqa: optional
 
 from kaiju_tools.app import ContextableService
 from kaiju_tools.functions import async_run_in_thread
 from kaiju_tools.docker.images import DockerImage
 
 __all__ = ['DockerContainer']
```

## kaiju_tools/docker/images.py

```diff
@@ -2,16 +2,16 @@
 
 import tempfile
 import textwrap
 from datetime import datetime
 from pathlib import Path
 from typing import Awaitable, Optional
 
-import docker  # type: ignore
-from docker.errors import NotFound  # type: ignore
+import docker  # noqa: optional
+from docker.errors import NotFound  # noqa: optional
 
 from kaiju_tools.app import ContextableService
 from kaiju_tools.functions import async_run_in_thread
 
 __all__ = ['DockerImage']
```

## kaiju_tools/tests/fixtures.py

```diff
@@ -16,15 +16,15 @@
     LoggingService,
     ServiceContextManager,
     REQUEST_CONTEXT,
     REQUEST_SESSION,
     Scheduler,
     Service,
 )
-from kaiju_tools.interfaces import DataStore, UserInterface, TokenInterface, _Columns, _Row, _User, App  # noqa
+from kaiju_tools.interfaces import DataStore, UserInterface, TokenInterface, _Columns, _User, App  # noqa
 from kaiju_tools.rpc import JSONRPCServer, AbstractRPCCompatible
 from kaiju_tools.cache import BaseCacheService
 from kaiju_tools.locks import BaseLocksService, NotLockOwnerError, LockExistsError
 from kaiju_tools.sessions import SessionService, AuthenticationService, LoginService
 from kaiju_tools.templates import Condition
 from kaiju_tools.types import NSKey, TTLDict, Namespace, Session
 from kaiju_tools.streams import Listener, StreamRPCClient
@@ -130,49 +130,49 @@
         else:
             return {key: row[key] for key in row if key in columns}
 
     @staticmethod
     def _check_condition(row: dict, conditions: Optional[Condition]) -> bool:
         return conditions(row) if conditions else True
 
-    async def get(self, id: Hashable, columns: _Columns = '*', _connection=None) -> _Row:
+    async def get(self, id: Hashable, columns: _Columns = '*', _connection=None):
         await asyncio.sleep(0)
         try:
             row = self._ext[id]
         except KeyError:
             raise NotFound
         else:
             return self._filter_columns(row, columns)
 
-    async def m_get(self, id: Collection[Hashable], columns: _Columns = '*', _connection=None) -> Collection[_Row]:
+    async def m_get(self, id: Collection[Hashable], columns: _Columns = '*', _connection=None):
         await asyncio.sleep(0)
         rows = [self._ext.get(key) for key in id if key in self._ext]
         return [self._filter_columns(row, columns) for row in rows]
 
     async def exists(self, id: Hashable, _connection=None) -> bool:
         await asyncio.sleep(0)
         return id in self._ext
 
     async def m_exists(self, id: Collection[Hashable], _connection=None) -> FrozenSet[Hashable]:
         await asyncio.sleep(0)
         return frozenset(key for key in id if key in self._ext)
 
-    async def delete(self, id: Hashable, columns: _Columns = None, _connection=None) -> _Row:
+    async def delete(self, id: Hashable, columns: _Columns = None, _connection=None):
         await asyncio.sleep(0)
         try:
             row = self._ext.pop(id)
         except KeyError:
             raise NotFound
         else:
             if columns:
                 return self._filter_columns(row, columns)
 
     async def m_delete(
         self, id: Collection[Hashable] = None, conditions=None, columns: _Columns = None, _connection=None
-    ) -> Collection[_Row]:
+    ) -> Collection:
         await asyncio.sleep(0)
         if conditions:
             conditions = Condition(conditions)
         rows = []
         keys = id if id else tuple(self._ext.keys())
         for key in keys:
             if key in self._ext and self._check_condition(self._ext[key], conditions):
@@ -185,49 +185,49 @@
         self,
         data: dict,
         columns: _Columns = '*',
         _connection=None,
         on_conflict: str = None,
         on_conflict_keys: Collection = None,
         on_conflict_values=None,
-    ) -> _Row:
+    ):
         await asyncio.sleep(0)
         self._ext[self._get_primary_key(data)] = data
         if columns:
             return self._filter_columns(data, columns)
 
     async def m_create(
         self,
         data: Collection,
         columns: _Columns = '*',
         _connection=None,
         on_conflict: str = None,
         on_conflict_keys: Collection = None,
         on_conflict_values: dict = None,
-    ) -> Collection[_Row]:
+    ):
         await asyncio.sleep(0)
         rows = []
         for row in data:
             self._ext[self._get_primary_key(row)] = row
             rows.append(self._filter_columns(row, columns))
         if columns:
             return rows
 
-    async def update(self, id: Hashable, data, columns: _Columns = '*', _connection=None) -> _Row:
+    async def update(self, id: Hashable, data, columns: _Columns = '*', _connection=None):
         try:
             self._ext[id].update(data)
         except KeyError:
             raise NotFound
         else:
             if columns:
                 return self._filter_columns(self._ext[id], columns)
 
     async def m_update(
         self, id: Collection[Hashable], data, conditions=None, columns: _Columns = '*', _connection=None
-    ) -> Collection[_Row]:
+    ):
         if conditions:
             conditions = Condition(conditions)
         rows = []
         keys = id if id else tuple(self._ext.keys())
         for key in keys:
             if key in self._ext and self._check_condition(self._ext[key], conditions):
                 self._ext[key].update(data)
@@ -364,20 +364,45 @@
 
 
 class _MockUserService(Service, UserInterface):
     def __init__(self, *args, session: Session, **kws):
         super().__init__(*args, **kws)
         self.username = uuid.uuid4().hex
         self.password = uuid.uuid4().hex
+        self.user_id = uuid.uuid4()
+        self.profile = {}
         self.session = session
 
+    def get_user(self):
+        return {
+            'id': self.user_id,
+            'username': self.username,
+            'permissions': frozenset({'user'}),
+            'settings': self.profile,
+        }
+
     async def auth(self, username: str, password: str) -> Optional[_User]:
         if username == self.username and password == self.password:
             return TokenInterface.TokenClaims(id=self.session.user_id, permissions=self.session.permissions)
 
+    async def register(self, username: str, email: str, password: str, settings: dict = None) -> _User:
+        self.username = username
+        self.password = password
+        return self.get_user()
+
+    async def change_password(self, username: str, password: str, new_password: str):
+        if self.password != password or self.username != username:
+            raise ValidationError('Invalid password')
+        self.password = new_password
+
+    async def update_profile(self, id: uuid.UUID, settings: dict):
+        if id == self.user_id:
+            self.profile.update(settings)
+        return self.profile
+
 
 @pytest.fixture
 def mock_users(app, mock_session) -> _MockUserService:  # noqa: pycharm
     service = _MockUserService(app=app, session=mock_session)
     app.services.add_service(service)
     return service
 
@@ -550,81 +575,85 @@
 @pytest.fixture
 def mock_service(app) -> _MockService:
     service = _MockService(app=app)
     app.services.add_service(service)
     return service
 
 
-class _MockListener(Listener):
-    class MockTransport(Service):
-        def __init__(self, *args, **kws):
-            super().__init__(*args, **kws)
-            self.stream = asyncio.LifoQueue()
+class _MockStream(Service):
+    def __init__(self, *args, **kws):
+        super().__init__(*args, **kws)
+        self._stream = {}
 
-        async def add(self, body, headers):
-            await self.stream.put((body, headers))
+    def get_stream(self, topic) -> asyncio.LifoQueue:
+        if topic not in self._stream:
+            self._stream[topic] = asyncio.LifoQueue()
+        return self._stream[topic]
 
-    _transport: MockTransport
+
+class _MockListener(Listener):
+    _transport: _MockStream
 
     async def close(self):
-        await self._transport.stream.join()
+        await self._transport.get_stream(self._key).join()
         await super().close()
 
     @classmethod
     def get_transport_cls(cls) -> Type:
-        return _MockListener.MockTransport
+        return _MockStream
 
     async def _read_batch(self) -> list:
-        msg = await self._transport.stream.get()
+        msg = await self._transport.get_stream(self._key).get()
+        self.logger.debug('read')
         return [msg]
 
     async def _process_batch(self, batch: list) -> None:
         for msg in batch:
             await self._process_request(msg)
-            self._transport.stream.task_done()
+            self._transport.get_stream(self._key).task_done()
 
 
 @pytest.fixture
 def mock_listener(app, rpc, scheduler, mock_locks, mock_auth) -> _MockListener:
-    transport = _MockListener.MockTransport(app)
+    transport = _MockStream(app)
     service = _MockListener(
         app=app,
-        topic='test',
         transport=transport,
         authentication_service=mock_auth,
         rpc_service=rpc,
         scheduler=scheduler,
         locks_service=mock_locks,
     )
     app.services.add_service(transport)
     app.services.add_service(service)
     return service
 
 
 class _MockStreamClient(StreamRPCClient):
-    _transport: _MockListener.MockTransport
+    _transport: _MockStream
 
     @classmethod
     def get_transport_cls(cls) -> Type:
-        return _MockListener.MockTransport
+        return _MockStream
 
     async def write(self, topic, body, headers: dict = None, key=None) -> None:
         if isinstance(body, list):
             body = [req.repr() for req in body]
         else:
             body = body.repr()
-        await self._transport.stream.put((body, headers))
+        self.logger.debug('put', topic=topic)
+        await self._transport.get_stream(topic).put((body, headers))
 
 
 @pytest.fixture
 def mock_stream_client(app, mock_listener, mock_users) -> _MockStreamClient:
     service = _MockStreamClient(
         app=app,
-        app_name=app.name,
-        topic='test',
+        app_name=mock_listener.app.name,
+        topic=mock_listener.topic,
         transport=mock_listener._transport,  # noqa
         auth_str=f'Basic {mock_users.username}:{mock_users.password}',
         request_logs=True,
         response_logs=True,
     )
     app.services.add_service(service)
     return service
```

## kaiju_tools/tests/test_streams.py

```diff
@@ -15,15 +15,15 @@
     @pytest_asyncio.fixture
     async def _listener(self, app, mock_listener, mock_service, mock_sessions, mock_session):
         async with app.services:
             yield mock_listener
 
     @pytest.fixture
     def _queue(self, mock_listener) -> asyncio.Queue:
-        return mock_listener._transport.stream  # noqa
+        return mock_listener._transport.get_stream(mock_listener._key)  # noqa
 
     async def test_valid_requests(self, rpc, _listener: Listener, _queue, mock_service):
         rpc._enable_permissions = False
         value = uuid.uuid4()
         _queue.put_nowait(({'method': 'do.store', 'params': {'data': value}}, {}))
         await _queue.join()
         assert mock_service.stored == value
@@ -68,19 +68,19 @@
         self, app, mock_listener, mock_service, mock_sessions, mock_session, mock_stream_client
     ) -> StreamRPCClient:
         async with app.services:
             yield mock_stream_client
 
     @pytest.fixture
     def _queue(self, mock_listener) -> asyncio.Queue:
-        return mock_listener._transport.stream  # noqa
+        return mock_listener._transport.get_stream(mock_listener._key)  # noqa
 
     async def test_valid_request(self, _client, _queue, mock_service, mock_session):
         value = uuid.uuid4()
-        await _client.call('do.store', {'data': value}, app='pytest', topic='rpc')
+        await _client.call('do.store', {'data': value})
         await _queue.join()
         assert mock_service.stored == value
 
     @pytest.mark.parametrize(
         'req',
         [{'method': 'do.echo', 'params': 'wrong'}, {'method': 'do.fail', 'params': None}],
         ids=['failed pre-request', 'failed request'],
```

## Comparing `kaiju_tools-2.1.6.dist-info/LICENSE` & `kaiju_tools-2.1.7.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `kaiju_tools-2.1.6.dist-info/METADATA` & `kaiju_tools-2.1.7.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: kaiju-tools
-Version: 2.1.6
+Version: 2.1.7
 Summary: Base classes and services for a backend application.
 Home-page: https://gitlab.com/kaiju-python/kaiju-tools
 Author: antonnidhoggr@me.com
 Author-email: antonnidhoggr@me.com
 License: Apache Software License 2.0
 Classifier: Development Status :: 3 - Alpha
 Classifier: License :: OSI Approved :: Apache Software License
```

## Comparing `kaiju_tools-2.1.6.dist-info/RECORD` & `kaiju_tools-2.1.7.dist-info/RECORD`

 * *Files 7% similar despite different names*

```diff
@@ -1,53 +1,53 @@
-kaiju_tools/__init__.py,sha256=NliMGqCoZQN8yL0fSyR_KB9YevnW9J6BnH8wLAQHcJM,231
+kaiju_tools/__init__.py,sha256=RnnhlRFKP04MyCp68gM4skweYBf4lzmdvZq9hCrd8rY,231
 kaiju_tools/annotations.py,sha256=47ioFnGcZDvDElnCVRFlzkCU_A6a2UfWz_M8dfKBmpM,15027
 kaiju_tools/app.py,sha256=N7O4zflkyfRU5e3uhhsa4KySHRcpbCRWCs_TmqzJPIM,37347
 kaiju_tools/cache.py,sha256=pzlK_GEYfp0dus4uZDov4cd5d7I9wbdS6Y4QQSo9vlo,4699
 kaiju_tools/class_registry.py,sha256=0duhDIB_za-SPLkxI7mK6NsjGodw99i-ldoOGFSI5Q4,5430
 kaiju_tools/encoding.py,sha256=r0Jx4U5VLTCVswZC83lFDp5za1BY1jFJAm88w3rGEyg,12475
 kaiju_tools/exceptions.py,sha256=_z9yJd2zJv32Z76bDnlVCtBSN9b0FRWRsfJGf4xcB94,5310
 kaiju_tools/functions.py,sha256=ZeyIGCUqrYcNpBZ_dF530I7KB3f4lfT52TATAWfb8Xg,8706
 kaiju_tools/http.py,sha256=Ld9ETI13WjMtucqEOEmxGq3XxbYdVfbfazy3JurpN_E,11388
-kaiju_tools/interfaces.py,sha256=GucM_Hyly5N6speLLst9Ay9L0vBmO6CuD81iDo1I-Mc,10864
+kaiju_tools/interfaces.py,sha256=M98QJIIKgk8YtqkBcUVT6-LBbv_liV-afJyhTjImz8k,11123
 kaiju_tools/jsonschema.py,sha256=AnNKjAfGWjgRLw4w8PYffh1WehLNjJrQ7lPsgjUjocY,10179
 kaiju_tools/locks.py,sha256=OGtfkqwECCMM1JK8Dtm2vOAsKJz4OK2NpH1SMQ30xeE,7548
 kaiju_tools/logging.py,sha256=ZG-ImBLpOvzB9MrSopVBlgNiCckO9QdXh7V_6iBGRGk,10446
 kaiju_tools/loop.py,sha256=DhiJ9jftB43RkeoTvOGKdwBbRFr4gj1Rz6uTLTYyF_U,210
 kaiju_tools/mapping.py,sha256=Z81ktH2IHLBw05KTvegA8mqch9vJMFwqZ4LnAKz8LiY,7839
 kaiju_tools/rpc.py,sha256=dkKxOgvFSt4_TY-AoW9Fan1zstXa50qHoVLXmZVmSAs,35361
 kaiju_tools/rpc_client_gen.py,sha256=8k31kUdwK2T4Zpwb-OBlNAoMK7k_2FDoX1LjhciD2yg,4416
 kaiju_tools/serialization.py,sha256=_TPV7HTUua5EEeUYEHCdqj_HHo2VdKpe2RusbeVIp8g,95
 kaiju_tools/services.py,sha256=hh7nSgw6cN59menn7LgeQ0R9gFmMQOrt1FLi22Rdhq8,702
-kaiju_tools/sessions.py,sha256=wLUuauGg_6h2AFp3KLcN0r7V7cv1oZ9By5AHLEyEpBg,16671
-kaiju_tools/streams.py,sha256=pknO3RtAc6xtCB6bn2vxbF8Q1uHDZYc_QHvSgnlySoE,9328
+kaiju_tools/sessions.py,sha256=7ipasQAmJYLJw4bQSkmzE3OplQdmJjMZkP9eKAoHSdE,17768
+kaiju_tools/streams.py,sha256=1t5rM8ypRoPxE04BRJu81vYzlKI-9AqML7mj_qVVKJ8,9379
 kaiju_tools/templates.py,sha256=GgvxXrGGuHe3X5gUxwTfartqLMhloFVj9bXwH0kWkOo,14417
 kaiju_tools/types.py,sha256=9WE-S_6V63fO1y8E9F9NFjJEhayF6fUzEjjseyyquLU,12410
 kaiju_tools/docker/__init__.py,sha256=cS3Xl3EMOWv0y_WRCi5GKFYXFrcpkievTVSyFUt0p4I,103
-kaiju_tools/docker/containers.py,sha256=LvvRYWRmsJCtZ-Gzp1jblxPKE-0Ixwwvyyo7x3mDqOs,9790
-kaiju_tools/docker/images.py,sha256=-fZlI1yePkvPT60ww-i8Z5viJjqIiz1imIk6aPWmrE8,7723
+kaiju_tools/docker/containers.py,sha256=j2M5cqXKTJvrySEtCSpEmYBgdLAKobsPaO0m7AGy2Q0,9786
+kaiju_tools/docker/images.py,sha256=2g2MshUYpMjFfVUzqSEJtBq0hRC6tl6qtQNagvPZbUk,7727
 kaiju_tools/docker/stack.py,sha256=dtoS3veOln42dG-um9d1datTwMJIUkR8vWPgVySYB1Y,11216
 kaiju_tools/docker/tests/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 kaiju_tools/docker/tests/fixtures.py,sha256=Y8qdiezKbnuZedZs-D0aUB7NakHqRyHDpfgDTunc9xA,1306
 kaiju_tools/docker/tests/test_containers.py,sha256=Yugtil6wQs2DGp6W0lNJM0ZoihzG5d95z0u5StGIfJ0,575
 kaiju_tools/docker/tests/test_images.py,sha256=XDJ1Z3XQSQswiJxDO_QtKmw4NymJpXhSdvHtxCGg8rE,359
 kaiju_tools/docker/tests/test_stack.py,sha256=qa6UbjCBiVmAORKyWTs9HaArZF0ZLBDZSzGJlc3Bjhs,371
 kaiju_tools/tests/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-kaiju_tools/tests/fixtures.py,sha256=xHsDxp1DdrNxJtO0cIYTXWTKjlZNNeRULHiFi6I1G04,19588
+kaiju_tools/tests/fixtures.py,sha256=Mc3-RVeWscnT3SF-MI3wQjaEr__hhWg8SAc3Bkom-Xs,20499
 kaiju_tools/tests/test_annotation_parser.py,sha256=jCQ5DR_EJEcyH5L5YzhKGw01_UlUxeiSd2i6zJUqhOU,9209
 kaiju_tools/tests/test_cache.py,sha256=Ko4Lx4thNU4IQK575xRAws7XVaAjLG0i_nMVFvn1kBg,1469
 kaiju_tools/tests/test_class_registry.py,sha256=P-XQ4nbAgH6TMBHoIEKpAdlMd1FL9tM9zm4f7L7Mpaw,1436
 kaiju_tools/tests/test_configurator.py,sha256=BwOmU6H4szzWDpK0JNq1b7Q1mm-yWGwAZ3O200MNLJc,552
 kaiju_tools/tests/test_data_store.py,sha256=CcJ-reywwRdJaLA-O2d1hJYU4MtGDLp-XQ__QuS3HQ0,3091
 kaiju_tools/tests/test_http.py,sha256=Du74YsCor7Gi4liKatH84PDIi-hHa_tm1w2bV8cxN4Y,2848
 kaiju_tools/tests/test_locks.py,sha256=-6h3amJnhWe5mf6uP1r2-laiaiXGMNfFpzThmyZfBlw,2097
 kaiju_tools/tests/test_mapping.py,sha256=tv60gtNz-89RBFw3vYuBD3QWi49FYkYvoOMgRQW74zY,3457
 kaiju_tools/tests/test_rpc.py,sha256=E_tzQJtoJHcfBJCZhoE9dcoFgkSbAGaM06z5ETnUL9I,9192
 kaiju_tools/tests/test_scheduler.py,sha256=XA2kHgGUDr_E2XpAQAt4eaWY_rJ1cMxo_AnlntM6r9Y,1554
 kaiju_tools/tests/test_serializers.py,sha256=VcQkjaZe8gjjg4Thyf-cEXp8uHgntPcZKc0jURg66qo,2800
 kaiju_tools/tests/test_services.py,sha256=cCZecNOXsY-j91l07_rG3rfKpXQiu6DeMqBCrbaBsuY,2207
-kaiju_tools/tests/test_streams.py,sha256=wmem6Q96ICZaPeh24OALtAZMeB3wsVbT4li8RCuERqo,3267
+kaiju_tools/tests/test_streams.py,sha256=aTCcSVAnVYpVQZ7kBn2TO8X2BERvOeyHQ7P_7h3xKPI,3288
 kaiju_tools/tests/test_templates.py,sha256=CoQdRatGZhGzPl_y4MYXPTQMA9c_wn0ieVITQaamrL4,1692
-kaiju_tools-2.1.6.dist-info/LICENSE,sha256=XIlN2qA8UqpBDA-PteoYP4hTU0qBW0G9PRB__khO2zc,610
-kaiju_tools-2.1.6.dist-info/METADATA,sha256=iLloVOs5aKBCGM755beYvz2Z9oWgAhnk432tBPKKKXQ,3360
-kaiju_tools-2.1.6.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
-kaiju_tools-2.1.6.dist-info/top_level.txt,sha256=DIgXUScFnJtRLiRWfjo547JK4rMuTIJoioMPRe1Jn6Y,12
-kaiju_tools-2.1.6.dist-info/RECORD,,
+kaiju_tools-2.1.7.dist-info/LICENSE,sha256=XIlN2qA8UqpBDA-PteoYP4hTU0qBW0G9PRB__khO2zc,610
+kaiju_tools-2.1.7.dist-info/METADATA,sha256=YAjQWb95DuG9zFQ1iA5n7YR94WuFi9KBvrCpAt3DDZY,3360
+kaiju_tools-2.1.7.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+kaiju_tools-2.1.7.dist-info/top_level.txt,sha256=DIgXUScFnJtRLiRWfjo547JK4rMuTIJoioMPRe1Jn6Y,12
+kaiju_tools-2.1.7.dist-info/RECORD,,
```

