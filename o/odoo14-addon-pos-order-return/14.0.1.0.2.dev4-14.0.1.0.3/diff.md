# Comparing `tmp/odoo14_addon_pos_order_return-14.0.1.0.2.dev4-py3-none-any.whl.zip` & `tmp/odoo14_addon_pos_order_return-14.0.1.0.3-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,41 +1,41 @@
-Zip file size: 164057 bytes, number of entries: 39
--rw-r--r--  2.0 unx     5269 b- defN 23-Mar-19 06:58 odoo/addons/pos_order_return/README.rst
--rw-r--r--  2.0 unx       42 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/__init__.py
--rw-r--r--  2.0 unx      912 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/__manifest__.py
--rw-r--r--  2.0 unx      751 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/demo/product_product.xml
--rw-r--r--  2.0 unx     9306 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/i18n/ca.po
--rw-r--r--  2.0 unx     9614 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/i18n/es.po
--rw-r--r--  2.0 unx     9126 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/i18n/fr.po
--rw-r--r--  2.0 unx     9886 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/i18n/it.po
--rw-r--r--  2.0 unx     8604 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/i18n/pos_order_return.pot
--rw-r--r--  2.0 unx     9882 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/i18n/pt.po
--rw-r--r--  2.0 unx       55 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/models/__init__.py
--rw-r--r--  2.0 unx     8133 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/models/pos_order.py
--rw-r--r--  2.0 unx      431 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/models/product_template.py
--rw-r--r--  2.0 unx      340 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/readme/CONFIGURE.rst
--rw-r--r--  2.0 unx      214 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx      184 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/readme/CREDITS.rst
--rw-r--r--  2.0 unx      317 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx      172 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/readme/ROADMAP.rst
--rw-r--r--  2.0 unx      831 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/readme/USAGE.rst
--rw-r--r--  2.0 unx      322 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/security/ir.model.access.csv
--rw-r--r--  2.0 unx     7876 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/static/description/icon.png
--rw-r--r--  2.0 unx    16619 b- defN 23-Mar-19 06:58 odoo/addons/pos_order_return/static/description/index.html
--rw-r--r--  2.0 unx    10574 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/static/description/initial_pos_order_required.png
--rw-r--r--  2.0 unx    24285 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/static/description/partial_return_wizard.png
--rw-r--r--  2.0 unx    49207 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/static/description/product_returnable_bottle.png
--rw-r--r--  2.0 unx    10644 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/static/description/returned_qty_over_initial.png
--rw-r--r--  2.0 unx    11731 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/static/description/sum_returned_qty_over_initial.png
--rw-r--r--  2.0 unx    22864 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/static/img/product_returnable_bottle-image.jpg
--rw-r--r--  2.0 unx       36 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/tests/__init__.py
--rw-r--r--  2.0 unx     6396 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/tests/test_pos_order_return.py
--rw-r--r--  2.0 unx     2897 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/views/pos_order_view.xml
--rw-r--r--  2.0 unx      591 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/views/product_product_view.xml
--rw-r--r--  2.0 unx       40 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/wizard/__init__.py
--rw-r--r--  2.0 unx     2488 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/wizard/pos_partial_return_wizard.py
--rw-r--r--  2.0 unx     1290 b- defN 23-Mar-19 06:57 odoo/addons/pos_order_return/wizard/pos_partial_return_wizard_view.xml
--rw-r--r--  2.0 unx     5876 b- defN 23-Mar-19 06:59 odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 23-Mar-19 06:59 odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 23-Mar-19 06:59 odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     4304 b- defN 23-Mar-19 06:59 odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/RECORD
-39 files, 252206 bytes uncompressed, 156767 bytes compressed:  37.8%
+Zip file size: 164918 bytes, number of entries: 39
+-rw-r--r--  2.0 unx     5331 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/README.rst
+-rw-r--r--  2.0 unx       42 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/__init__.py
+-rw-r--r--  2.0 unx      912 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/__manifest__.py
+-rw-r--r--  2.0 unx      751 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/demo/product_product.xml
+-rw-r--r--  2.0 unx     9306 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/i18n/ca.po
+-rw-r--r--  2.0 unx     9614 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/i18n/es.po
+-rw-r--r--  2.0 unx     9126 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/i18n/fr.po
+-rw-r--r--  2.0 unx     9886 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/i18n/it.po
+-rw-r--r--  2.0 unx     8604 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/i18n/pos_order_return.pot
+-rw-r--r--  2.0 unx     9882 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/i18n/pt.po
+-rw-r--r--  2.0 unx       55 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/models/__init__.py
+-rw-r--r--  2.0 unx     9378 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/models/pos_order.py
+-rw-r--r--  2.0 unx      431 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/models/product_template.py
+-rw-r--r--  2.0 unx      340 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/readme/CONFIGURE.rst
+-rw-r--r--  2.0 unx      214 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx      184 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/readme/CREDITS.rst
+-rw-r--r--  2.0 unx      317 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx      234 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/readme/ROADMAP.rst
+-rw-r--r--  2.0 unx      831 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/readme/USAGE.rst
+-rw-r--r--  2.0 unx      322 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/security/ir.model.access.csv
+-rw-r--r--  2.0 unx     7876 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/static/description/icon.png
+-rw-r--r--  2.0 unx    16710 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/static/description/index.html
+-rw-r--r--  2.0 unx    10574 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/static/description/initial_pos_order_required.png
+-rw-r--r--  2.0 unx    24285 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/static/description/partial_return_wizard.png
+-rw-r--r--  2.0 unx    49207 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/static/description/product_returnable_bottle.png
+-rw-r--r--  2.0 unx    10644 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/static/description/returned_qty_over_initial.png
+-rw-r--r--  2.0 unx    11731 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/static/description/sum_returned_qty_over_initial.png
+-rw-r--r--  2.0 unx    22864 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/static/img/product_returnable_bottle-image.jpg
+-rw-r--r--  2.0 unx       36 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/tests/__init__.py
+-rw-r--r--  2.0 unx    10809 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/tests/test_pos_order_return.py
+-rw-r--r--  2.0 unx     2897 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/views/pos_order_view.xml
+-rw-r--r--  2.0 unx      591 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/views/product_product_view.xml
+-rw-r--r--  2.0 unx       40 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/wizard/__init__.py
+-rw-r--r--  2.0 unx     2488 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/wizard/pos_partial_return_wizard.py
+-rw-r--r--  2.0 unx     1290 b- defN 23-Jun-29 09:34 odoo/addons/pos_order_return/wizard/pos_partial_return_wizard_view.xml
+-rw-r--r--  2.0 unx     5933 b- defN 23-Jun-29 09:34 odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Jun-29 09:34 odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Jun-29 09:34 odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     4285 b- defN 23-Jun-29 09:34 odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/RECORD
+39 files, 258117 bytes uncompressed, 157668 bytes compressed:  38.9%
```

## zipnote {}

```diff
@@ -99,20 +99,20 @@
 
 Filename: odoo/addons/pos_order_return/wizard/pos_partial_return_wizard.py
 Comment: 
 
 Filename: odoo/addons/pos_order_return/wizard/pos_partial_return_wizard_view.xml
 Comment: 
 
-Filename: odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/METADATA
+Filename: odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/METADATA
 Comment: 
 
-Filename: odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/WHEEL
+Filename: odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/WHEEL
 Comment: 
 
-Filename: odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/top_level.txt
+Filename: odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/RECORD
+Filename: odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/pos_order_return/README.rst

```diff
@@ -81,17 +81,18 @@
   not indicated:
 
 .. image:: https://raw.githubusercontent.com/OCA/pos/14.0/pos_order_return/static/description/initial_pos_order_required.png
 
 Known issues / Roadmap
 ======================
 
-When migrating the module ``pos_order_return`` in version > 12.0 please merge
-both modules ``pos_order_return`` and ``pos_order_return_traceability`` into a
-single module.
+* When migrating the module ``pos_order_return`` in version > 12.0 please merge
+  both modules ``pos_order_return`` and ``pos_order_return_traceability`` into a
+  single module.
+* Stock update on session close is uncovered right now.
 
 Bug Tracker
 ===========
 
 Bugs are tracked on `GitHub Issues <https://github.com/OCA/pos/issues>`_.
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
```

## odoo/addons/pos_order_return/__manifest__.py

```diff
@@ -1,15 +1,15 @@
 # Copyright 2016-2018 Sylvain LE GAL (https://twitter.com/legalsylvain)
 # Copyright 2018 David Vidal <david.vidal@tecnativa.com>
 # Copyright 2018 Lambda IS DOOEL <https://www.lambda-is.com>
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl.html).
 
 {
     "name": "Point of Sale Order Return",
-    "version": "14.0.1.0.1",
+    "version": "14.0.1.0.3",
     "category": "Point Of Sale",
     "author": "La Louve, "
     "GRAP, "
     "Tecnativa, "
     "Lambda IS, "
     "Odoo Community Association (OCA)",
     "license": "AGPL-3",
```

## odoo/addons/pos_order_return/models/pos_order.py

```diff
@@ -1,15 +1,14 @@
 # Copyright 2016-2018 Sylvain LE GAL (https://twitter.com/legalsylvain)
 # Copyright 2018 David Vidal <david.vidal@tecnativa.com>
 # Copyright 2018 Lambda IS DOOEL <https://www.lambda-is.com>
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl.html).
-
-
 from odoo import _, api, fields, models
 from odoo.exceptions import ValidationError
+from odoo.tests import Form
 
 
 class PosOrder(models.Model):
     _inherit = "pos.order"
 
     returned_order_id = fields.Many2one(
         comodel_name="pos.order",
@@ -105,46 +104,77 @@
 
     def action_pos_order_paid(self):
         res = super().action_pos_order_paid()
         if self.returned_order_id and self.returned_order_id.account_move:
             self._action_pos_order_invoice()
         return res
 
+    def _get_picking_destination(self):
+        picking_type = self.config_id.picking_type_id
+        if self.partner_id.property_stock_customer:
+            destination = self.partner_id.property_stock_customer
+        elif not picking_type or not picking_type.default_location_dest_id:
+            destination = self.env["stock.warehouse"]._get_partner_locations()[0]
+        else:
+            destination = picking_type.default_location_dest_id
+        return destination
+
     def _create_picking_return(self):
         self.ensure_one()
-        picking = self.returned_order_id.picking_ids
-        ctx = dict(self.env.context, active_ids=picking.ids, active_id=picking.id)
-        wizard = self.env["stock.return.picking"].with_context(ctx).create({})
+        return_form = Form(
+            self.env["stock.return.picking"].with_context(
+                active_id=self.returned_order_id.picking_ids.filtered(
+                    lambda picking: picking.location_dest_id.usage == "customer"
+                ).id,
+                active_model="stock.picking",
+            )
+        )
+        wizard = return_form.save()
         # Discard not returned lines
         wizard.product_return_moves.filtered(
             lambda x: x.product_id not in self.mapped("lines.product_id")
         ).unlink()
         to_return = {}
-        for product in self.lines.mapped("product_id"):
-            to_return[product] = -sum(
-                self.lines.filtered(lambda x: x.product_id == product).mapped("qty")
-            )
+        order_lines = self.lines
+        for order_line in order_lines:
+            to_return.setdefault(order_line.product_id, 0)
+            if order_line.qty > 0:
+                continue
+            order_lines -= order_line
+            to_return[order_line.product_id] += order_line.qty
         for move in wizard.product_return_moves:
-            if to_return[move.product_id] < move.quantity:
-                move.quantity = to_return[move.product_id]
+            if abs(to_return[move.product_id]) < move.quantity:
+                move.quantity = abs(to_return[move.product_id])
             to_return[move.product_id] -= move.quantity
-        return wizard
+        picking = self.env["stock.picking"].browse(wizard.create_returns()["res_id"])
+        normal_picking = self.env["stock.picking"]._create_picking_from_pos_order_lines(
+            self._get_picking_destination().id,
+            order_lines,
+            self.config_id.picking_type_id,
+            self.partner_id,
+        )
+        for move in picking.move_lines:
+            move.quantity_done = move.product_uom_qty
+        picking._action_done()
+        (picking | normal_picking).write(
+            {
+                "pos_session_id": self.session_id.id,
+                "pos_order_id": self.id,
+                "origin": self.name,
+            }
+        )
+        return picking | normal_picking
 
     def _create_order_picking(self):
         """Odoo bases return picking if the quantities are negative, but it's
         not linked to the original one"""
-        orders = self.filtered(
-            lambda x: not x.returned_order_id or not x.returned_order_id.picking_ids
-        )
-        res = super()._create_order_picking()
-        for order in self - orders:
-            wizard = order._create_picking_return()
-            res = wizard.create_returns()
-            order.write({"picking_ids": (6, 0, [res["res_id"]])})
-        return res
+        self.ensure_one()
+        if not self.returned_order_id.picking_ids:
+            return super()._create_order_picking()
+        self.picking_ids = self._create_picking_return()
 
 
 class PosOrderLine(models.Model):
     _inherit = "pos.order.line"
 
     returned_line_id = fields.Many2one(
         comodel_name="pos.order.line",
```

## odoo/addons/pos_order_return/readme/ROADMAP.rst

```diff
@@ -1,3 +1,4 @@
-When migrating the module ``pos_order_return`` in version > 12.0 please merge
-both modules ``pos_order_return`` and ``pos_order_return_traceability`` into a
-single module.
+* When migrating the module ``pos_order_return`` in version > 12.0 please merge
+  both modules ``pos_order_return`` and ``pos_order_return_traceability`` into a
+  single module.
+* Stock update on session close is uncovered right now.
```

## odoo/addons/pos_order_return/static/description/index.html

### odoo/addons/pos_order_return/static/description/index.html

```diff
@@ -477,25 +477,28 @@
         </ul>
         <img alt="https://raw.githubusercontent.com/OCA/pos/14.0/pos_order_return/static/description/initial_pos_order_required.png" src="https://raw.githubusercontent.com/OCA/pos/14.0/pos_order_return/static/description/initial_pos_order_required.png"/>
       </div>
       <div class="section" id="known-issues-roadmap">
         <h1>
           <a class="toc-backref" href="#id3">Known issues / Roadmap</a>
         </h1>
-        <p>
-          When migrating the module
-          <tt class="docutils literal">pos_order_return</tt>
-          in version &gt; 12.0 please merge
+        <ul class="simple">
+          <li>
+            When migrating the module
+            <tt class="docutils literal">pos_order_return</tt>
+            in version &gt; 12.0 please merge
 both modules
-          <tt class="docutils literal">pos_order_return</tt>
-          and
-          <tt class="docutils literal">pos_order_return_traceability</tt>
-          into a
+            <tt class="docutils literal">pos_order_return</tt>
+            and
+            <tt class="docutils literal">pos_order_return_traceability</tt>
+            into a
 single module.
-        </p>
+          </li>
+          <li>Stock update on session close is uncovered right now.</li>
+        </ul>
       </div>
       <div class="section" id="bug-tracker">
         <h1>
           <a class="toc-backref" href="#id4">Bug Tracker</a>
         </h1>
         <p>
           Bugs are tracked on
```

## odoo/addons/pos_order_return/tests/test_pos_order_return.py

```diff
@@ -1,21 +1,19 @@
 # Copyright 2018 Tecnativa - David Vidal
 # Copyright 2018 Lambda IS DOOEL <https://www.lambda-is.com>
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl.html).
-
-import unittest
-
 from odoo.tests import common, tagged
 
 
 @tagged("post_install", "-at_install")
 class TestPOSOrderReturn(common.SavepointCase):
-    def setUp(self):
-        super(TestPOSOrderReturn, self).setUp()
-        self.pricelist = self.env["product.pricelist"].create(
+    @classmethod
+    def setUpClass(cls):
+        super(TestPOSOrderReturn, cls).setUpClass()
+        cls.pricelist = cls.env["product.pricelist"].create(
             {
                 "name": "Test pricelist",
                 "item_ids": [
                     (
                         0,
                         0,
                         {
@@ -23,106 +21,121 @@
                             "compute_price": "formula",
                             "base": "list_price",
                         },
                     )
                 ],
             }
         )
-        self.partner = self.env["res.partner"].create(
+        cls.partner = cls.env["res.partner"].create(
             {
                 "name": "Mr. Odoo",
-                "property_product_pricelist": self.pricelist.id,
+                "property_product_pricelist": cls.pricelist.id,
             }
         )
-        self.product_1 = self.env["product.product"].create(
+        cls.product_1 = cls.env["product.product"].create(
             {
                 "name": "Test product 1",
                 "standard_price": 1.0,
                 "type": "product",
                 "pos_allow_negative_qty": False,
                 "taxes_id": False,
             }
         )
-        self.product_2 = self.env["product.product"].create(
+        cls.product_2 = cls.env["product.product"].create(
             {
                 "name": "Test product 2",
                 "standard_price": 1.0,
                 "type": "product",
                 "pos_allow_negative_qty": True,
                 "taxes_id": False,
             }
         )
-        self.PosOrder = self.env["pos.order"]
-        self.pos_config = self.env.ref("point_of_sale.pos_config_main")
-        self.pos_config.open_session_cb()
-        self.pos_order = self.PosOrder.create(
-            {
-                "session_id": self.pos_config.current_session_id.id,
-                "partner_id": self.partner.id,
-                "pricelist_id": self.partner.property_product_pricelist.id,
+        cls.product_3 = cls.env["product.product"].create(
+            {
+                "name": "Test product 3",
+                "standard_price": 1.0,
+                "type": "product",
+                "pos_allow_negative_qty": True,
+                "taxes_id": False,
+            }
+        )
+        cls.PosOrder = cls.env["pos.order"]
+        cls.PosOrderLine = cls.env["pos.order.line"]
+        cls.pos_config = cls.env.ref("point_of_sale.pos_config_main")
+        cls.pos_config.write(
+            {
+                "available_pricelist_ids": [(6, 0, cls.pricelist.ids)],
+                "pricelist_id": cls.pricelist.id,
+            }
+        )
+        cls.pos_config.company_id.point_of_sale_update_stock_quantities = False
+        cls.pos_config.open_session_cb()
+        cls.pos_order = cls.PosOrder.create(
+            {
+                "session_id": cls.pos_config.current_session_id.id,
+                "partner_id": cls.partner.id,
+                "pricelist_id": cls.partner.property_product_pricelist.id,
                 "amount_tax": 0,
-                "amount_total": 2700,
-                "amount_paid": 2700,
+                "amount_total": 1350,
+                "amount_paid": 1350,
                 "amount_return": 0,
                 "lines": [
                     (
                         0,
                         0,
                         {
                             "name": "POSLINE/0001",
-                            "product_id": self.product_1.id,
-                            "price_unit": 450,
+                            "product_id": cls.product_1.id,
+                            "price_unit": 225,
                             "price_subtotal": 450,
                             "price_subtotal_incl": 450,
                             "qty": 2.0,
                         },
                     ),
                     (
                         0,
                         0,
                         {
                             "name": "POSLINE/0002",
-                            "product_id": self.product_2.id,
-                            "price_unit": 450,
+                            "product_id": cls.product_2.id,
+                            "price_unit": 225,
                             "price_subtotal": 450,
                             "price_subtotal_incl": 450,
                             "qty": 2.0,
                         },
                     ),
                     (
                         0,
                         0,
                         {
                             "name": "POSLINE/0003",
-                            "product_id": self.product_1.id,
-                            "price_unit": 450,
+                            "product_id": cls.product_1.id,
+                            "price_unit": 225,
                             "price_subtotal": 450,
                             "price_subtotal_incl": 450,
                             "qty": 2.0,
                         },
                     ),
                 ],
             }
         )
         pos_make_payment = (
-            self.env["pos.make.payment"]
+            cls.env["pos.make.payment"]
             .with_context(
                 {
-                    "active_ids": [self.pos_order.id],
-                    "active_id": self.pos_order.id,
+                    "active_ids": [cls.pos_order.id],
+                    "active_id": cls.pos_order.id,
                 }
             )
             .create({})
         )
-        pos_make_payment.with_context(active_id=self.pos_order.id).check()
-        self.pos_order._create_order_picking()
-        res = self.pos_order.action_pos_order_invoice()
-        self.invoice = self.env["account.move"].browse(res["res_id"])
+        pos_make_payment.with_context(active_id=cls.pos_order.id).check()
+        res = cls.pos_order.action_pos_order_invoice()
+        cls.invoice = cls.env["account.move"].browse(res["res_id"])
 
-    @unittest.skip("Errors introduced due to recent odoo changes")
     def test_pos_order_full_refund(self):
         self.pos_order.refund()
         refund_order = self.pos_order.refund_order_ids
         self.assertEqual(len(refund_order), 1)
         pos_make_payment = (
             self.env["pos.make.payment"]
             .with_context(
@@ -136,15 +149,14 @@
         pos_make_payment.with_context(active_id=refund_order.id).check()
         refund_invoice = refund_order.account_move
         refund_order.action_pos_order_invoice()
         self.assertEqual(refund_invoice.reversed_entry_id, self.invoice)
         # Partner balance is 0
         self.assertEqual(sum(self.partner.mapped("invoice_ids.amount_total_signed")), 0)
 
-    @unittest.skip("Errors introduced due to recent odoo changes")
     def test_pos_order_partial_refund(self):
         partial_refund = (
             self.env["pos.partial.return.wizard"]
             .with_context(
                 {
                     "active_ids": self.pos_order.ids,
                     "active_id": self.pos_order.id,
@@ -169,9 +181,124 @@
                 }
             )
             .create({})
         )
         pos_make_payment.with_context(active_id=refund_order.id).check()
         # Partner balance is 1350
         self.assertEqual(
-            sum(self.partner.mapped("invoice_ids.amount_total_signed")), 1350
+            sum(self.partner.mapped("invoice_ids.amount_total_signed")), 675.0
+        )
+
+    def __new_sale(self, qty, lines_qty_to_return, new_product):
+        partial_refund = (
+            self.env["pos.partial.return.wizard"]
+            .with_context(
+                {
+                    "active_ids": self.pos_order.ids,
+                    "active_id": self.pos_order.id,
+                }
+            )
+            .create({})
+        )
+        for line_index, return_qty in lines_qty_to_return:
+            partial_refund.line_ids[line_index].qty = return_qty
+        partial_refund.confirm()
+        refund_order = self.pos_order.refund_order_ids
+        # Customer exchanges 3 items for another product POSLINE/0004
+        self.PosOrderLine.create(
+            {
+                "name": "POSLINE/0004",
+                "order_id": refund_order.id,
+                "product_id": new_product.id,
+                "price_unit": 225,
+                "price_subtotal": 225 * qty,
+                "price_subtotal_incl": 225 * qty,
+                "qty": qty,
+            }
+        )
+        refund_order._onchange_amount_all()
+        pos_make_payment = (
+            self.env["pos.make.payment"]
+            .with_context(
+                {
+                    "active_ids": refund_order.ids,
+                    "active_id": refund_order.id,
+                }
+            )
+            .create({})
+        )
+        pos_make_payment.with_context(active_id=refund_order.id).check()
+        return refund_order
+
+    def test_pos_order_full_refund_and_new_equal_sale(self):
+        # The customer exchanges 3 items for the same quantity of another product.
+        refund_order = self.__new_sale(
+            3.0,
+            [
+                (0, 1.0),  # POSLINE/0001
+                (2, 2.0),  # POSLINE/0003
+            ],
+            self.product_2,
+        )
+        self.assertEqual(len(refund_order), 1)
+        self.assertEqual(len(refund_order.lines), 3)
+        self.assertEqual(
+            sum(self.partner.mapped("invoice_ids.amount_total_signed")), 1350.0
+        )
+
+    def test_pos_order_full_refund_and_new_lower_sale(self):
+        # Customer exchanges 3 items for 2 of another product
+        refund_order = self.__new_sale(
+            2.0,
+            [
+                (0, 1.0),  # POSLINE/0001
+                (2, 2.0),  # POSLINE/0003
+            ],
+            self.product_2,
+        )
+        self.assertEqual(len(refund_order), 1)
+        self.assertEqual(len(refund_order.lines), 3)
+        self.assertEqual(
+            sum(self.partner.mapped("invoice_ids.amount_total_signed")), 1125.0
+        )
+
+    def test_pos_order_full_refund_and_new_higher_sale(self):
+        # Customer exchanges 3 items for 4 of another product.
+        refund_order = self.__new_sale(
+            4.0,
+            [
+                (0, 1.0),  # POSLINE/0001
+                (2, 2.0),  # POSLINE/0003
+            ],
+            self.product_2,
+        )
+        self.assertEqual(len(refund_order), 1)
+        self.assertEqual(len(refund_order.lines), 3)
+        self.assertEqual(
+            sum(self.partner.mapped("invoice_ids.amount_total_signed")), 1575.0
+        )
+
+    def test_pos_order_several_refund_and_new_sale(self):
+        # The customer refund an order placed through a previous refund.
+        refund_order = self.__new_sale(
+            3.0,
+            [
+                (0, 1.0),  # POSLINE/0001
+                (2, 2.0),  # POSLINE/0003
+            ],
+            self.product_2,
+        )
+        self.assertEqual(len(refund_order), 1)
+        self.assertEqual(len(refund_order.lines), 3)
+        self.pos_order = self.PosOrder.search([], limit=1, order="id desc")
+        refund_order = self.__new_sale(
+            5.0,
+            [
+                (2, 3.0),  # POSLINE/0004
+            ],
+            self.product_3,
+        )
+        self.assertEqual(len(refund_order), 1)
+        self.assertEqual(len(refund_order.lines), 2)
+        self.assertEqual(
+            sum(self.partner.mapped("invoice_ids.amount_total_signed")), 1800.0
         )
```

## Comparing `odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/METADATA` & `odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/METADATA`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo14-addon-pos-order-return
-Version: 14.0.1.0.2.dev4
+Version: 14.0.1.0.3
 Summary: Point of Sale Order Return
 Home-page: https://github.com/OCA/pos
 Author: La Louve, GRAP, Tecnativa, Lambda IS, Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
@@ -98,17 +98,18 @@
   not indicated:
 
 .. image:: https://raw.githubusercontent.com/OCA/pos/14.0/pos_order_return/static/description/initial_pos_order_required.png
 
 Known issues / Roadmap
 ======================
 
-When migrating the module ``pos_order_return`` in version > 12.0 please merge
-both modules ``pos_order_return`` and ``pos_order_return_traceability`` into a
-single module.
+* When migrating the module ``pos_order_return`` in version > 12.0 please merge
+  both modules ``pos_order_return`` and ``pos_order_return_traceability`` into a
+  single module.
+* Stock update on session close is uncovered right now.
 
 Bug Tracker
 ===========
 
 Bugs are tracked on `GitHub Issues <https://github.com/OCA/pos/issues>`_.
 In case of trouble, please check there if your issue has already been reported.
 If you spotted it first, help us smashing it by providing a detailed and welcomed
```

## Comparing `odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/RECORD` & `odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/RECORD`

 * *Files 10% similar despite different names*

```diff
@@ -1,39 +1,39 @@
-odoo/addons/pos_order_return/README.rst,sha256=oTpk6DIMwGyL1CFVkww8g3RaA3VsP7jIrG6qJNl73WE,5269
+odoo/addons/pos_order_return/README.rst,sha256=dags1ZmVl5qv7lf93Mq-MW8QETjTMihBUinKqXdQCrA,5331
 odoo/addons/pos_order_return/__init__.py,sha256=R3l5zcM1DHY7iqr3kt92069kmImpPafRbNSzv6p_hBE,42
-odoo/addons/pos_order_return/__manifest__.py,sha256=WFjZ1U-hjPf5YYHDmghfFOEi_uqzed-PPDY1BKkP_Fk,912
+odoo/addons/pos_order_return/__manifest__.py,sha256=a1cd_JIAW3XbljcC1jxPnM36HWx3YqGHwb9aQxcqHms,912
 odoo/addons/pos_order_return/demo/product_product.xml,sha256=AnWQTjH1rapidcEBqmwXHxawBfpVn8Jut1lDqJUvaQo,751
 odoo/addons/pos_order_return/i18n/ca.po,sha256=aQMwsHHOUV3O0YSfRTp9UX-9kWvVZdlk1o5NpLb_NPY,9306
 odoo/addons/pos_order_return/i18n/es.po,sha256=wnV3bvownPEFFawej1dQgdlUQFusTLtlTYps9MBNLx0,9614
 odoo/addons/pos_order_return/i18n/fr.po,sha256=-9PjHqKEUyFJSntGLCDbvJVN4EIcLd0hEOEcDOtq55c,9126
 odoo/addons/pos_order_return/i18n/it.po,sha256=LbGkw-TlOqDicUyT7MsJTCjgJ4vP6tjHJl1L9NDKabg,9886
 odoo/addons/pos_order_return/i18n/pos_order_return.pot,sha256=BhMu_yA_8td2z4rOv8u7OFkaVvW4Cdr4pexfKJKpAe4,8604
 odoo/addons/pos_order_return/i18n/pt.po,sha256=qjWDo3B_4VLMFmdEsbyMPHLf8cIaUw6FHkxLdaHlvvc,9882
 odoo/addons/pos_order_return/models/__init__.py,sha256=T4NChg3kQRpzlwOGbyF8C6gAJG0z5ztFmQtIMu_qdok,55
-odoo/addons/pos_order_return/models/pos_order.py,sha256=VYWuIQhdy5Uyk-iOvpY857PeVu9p51ivnYJlpbpLap4,8133
+odoo/addons/pos_order_return/models/pos_order.py,sha256=IWo2Xdl08k3EtFBfb8X1AYAlTZotJmHuSWLLS1QlTGU,9378
 odoo/addons/pos_order_return/models/product_template.py,sha256=R2bIzRas_SG6ebCJpflb9LuEFU5K3aSvp_NAHx3hMbY,431
 odoo/addons/pos_order_return/readme/CONFIGURE.rst,sha256=Kenx6cGqJDQyuzHTmxK5hBrM4qdQ-uty_5-gTSoyP6Y,340
 odoo/addons/pos_order_return/readme/CONTRIBUTORS.rst,sha256=joZpcoxiTSIrHlMBE4NWBH0gD18pZRMZBVlCAocgm9M,214
 odoo/addons/pos_order_return/readme/CREDITS.rst,sha256=wCNBMCcwa9PvJOTicQSBKlv63LX9Nyf1AA9OMj5bILY,184
 odoo/addons/pos_order_return/readme/DESCRIPTION.rst,sha256=ZVZZLgsqcYNegAMLRjBsokIfYyNMHueM637sVRU4D4w,317
-odoo/addons/pos_order_return/readme/ROADMAP.rst,sha256=OWkTl1iwJgvGrJUj151ROjkB4BBP9plXKgHSghYuPBQ,172
+odoo/addons/pos_order_return/readme/ROADMAP.rst,sha256=kTagvhMxjnpbUfVYj51NDNfJseDrTC6EA83BgaledXI,234
 odoo/addons/pos_order_return/readme/USAGE.rst,sha256=ACVgJzbFAykiNAmIBwlsZ5eLR-lKnj_pd79GRBxph20,831
 odoo/addons/pos_order_return/security/ir.model.access.csv,sha256=SwcCn57IZ86O7J8jqCn4lGzBCARuTd1sURHV53JCyxU,322
 odoo/addons/pos_order_return/static/description/icon.png,sha256=pTqZhGxMLfYgMExCmt6X9ROjkO0xOqBBtSlXeT48Zao,7876
-odoo/addons/pos_order_return/static/description/index.html,sha256=pemND9vOTHjHLE5Sty4POzluKRnyl_l07Q1U43OFlb8,16619
+odoo/addons/pos_order_return/static/description/index.html,sha256=vi6FJ64oSU_H9eVbAV89pE4UnxZ7tbfazgCtAcJgYO4,16710
 odoo/addons/pos_order_return/static/description/initial_pos_order_required.png,sha256=WEh0eHjqsfEfSUx8Yrayjc3b-O7gFcQZGX8qKiGLuEc,10574
 odoo/addons/pos_order_return/static/description/partial_return_wizard.png,sha256=RhEpci0roEtoNUmUk5g7XNAPFO-ODwonNHeo82HoSZU,24285
 odoo/addons/pos_order_return/static/description/product_returnable_bottle.png,sha256=1_fgLFPt0BP35AiO9YsrzcuriXgpSnB889aA8gFontE,49207
 odoo/addons/pos_order_return/static/description/returned_qty_over_initial.png,sha256=yB9zu4Ec5hkXTBZjqqLPSNi7AlJyb7Mkb15P3cwmb4I,10644
 odoo/addons/pos_order_return/static/description/sum_returned_qty_over_initial.png,sha256=RzLhpX3Ce2L4KLTkP_isqSP55zFhCn_MmTGx6-KdM6o,11731
 odoo/addons/pos_order_return/static/img/product_returnable_bottle-image.jpg,sha256=QKfsS8IJKyKaG8KFyzAHO3U9HQaxC7AsF4FHymhNbAc,22864
 odoo/addons/pos_order_return/tests/__init__.py,sha256=1Wooi5Tr3msayi95XyMjJkAvd63Dnv7tBoBf6xJ0kSQ,36
-odoo/addons/pos_order_return/tests/test_pos_order_return.py,sha256=N00WvCWXRYgi2L_gRim7axxS3tECz7cJw7CDiiR3Sic,6396
+odoo/addons/pos_order_return/tests/test_pos_order_return.py,sha256=zi6IgzrPW25VtmdD848aRN3blT4XiWqcW_vitZI7gNo,10809
 odoo/addons/pos_order_return/views/pos_order_view.xml,sha256=ThvVvD6mL4w6SSdUoxnf-vMp7kCyHo-_9HUarj1M97s,2897
 odoo/addons/pos_order_return/views/product_product_view.xml,sha256=7xM_pje3GUqZ7DmYmUO8ruPaXOjq5pd8ywixum5QKiM,591
 odoo/addons/pos_order_return/wizard/__init__.py,sha256=e3HAEtv6r4x_zxcF_AQcb7GrVbAYuLPiRwmaex6KdMo,40
 odoo/addons/pos_order_return/wizard/pos_partial_return_wizard.py,sha256=5BfvbiES9_GnbvX0zog-FHlT7ytKEsiGCvSZ2oQyBk8,2488
 odoo/addons/pos_order_return/wizard/pos_partial_return_wizard_view.xml,sha256=3x5T3r5PhZfOiod_GwhscUi1UwaMyyPDNN7cin-s_po,1290
-odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/METADATA,sha256=q3gkOMhhn_q4_P6-nkoMeN0_P6Jo-3u3SGo43TzEK80,5876
-odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
-odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo14_addon_pos_order_return-14.0.1.0.2.dev4.dist-info/RECORD,,
+odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/METADATA,sha256=omvZN15RYAbDVrmQztEfBW7C3QAsyUjVppdSKpnI49Q,5933
+odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/WHEEL,sha256=pkctZYzUS4AYVn6dJ-7367OJZivF2e8RA9b_ZBjif18,92
+odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo14_addon_pos_order_return-14.0.1.0.3.dist-info/RECORD,,
```

